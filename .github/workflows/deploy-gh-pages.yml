name: build and deploy
on: 
  push:
    branches:
      - main
jobs:

  build-emscripten-module:
    runs-on: ubuntu-latest
    container: emscripten/emsdk:latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get -y update
          sudo apt-get -y install cmake
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ololoken/CorsixTH
          ref: refs/heads/master
      - name: Build wasm module 🔧
        run: |
          git config --global --add safe.directory "*"
          emcmake cmake . -Bbuild --debug-output -LA -DCMAKE_BUILD_TYPE=Release
          emcmake cmake --build build/ -- VERBOSE=1
          mkdir -p emscripten-module
          cp build/CorsixTH/corsix-th.* emscripten-module
      - name: Store artifact
        uses: actions/upload-artifact@v4
        with:
          name: emscripten-module
          path: emscripten-module

  build-ems-launcher:
    runs-on: ubuntu-latest
    needs: build-emscripten-module
    steps:
      - name: Checkout launcher 🛎️
        uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: emscripten-module
          path: src/assets/module/
      - name: Install and Build 🔧
        run: |
          npm install
          npm run build
      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages-demo
          folder: dist
